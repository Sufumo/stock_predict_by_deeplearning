# PINN-MTICG模型高保真复现实施方案

## 阶段一：环境与数据准备 (Prerequisites & Data Engineering)

### 1. 技术栈与环境配置

| 组件 | 作用 | 推荐库 | 参考开源项目 |
|------|------|--------|-------------|
| 核心框架 | 模型构建与训练 | PyTorch | - |
| 图结构 | GAT层实现与图数据处理 | PyTorch Geometric (PyG) | - |
| PINN支持 | 自动微分与物理损失项计算 | 自定义 PyTorch Module / DeepXDE | PINNsFormer, PINNs |x
| 时序模型 | Transformer模块基准实现 | Torch/HuggingFace Transformers | MASTER, SSPT |

### 2. 数据收集与预处理

#### A. 个股量价时序数据（高频）

**输入特征**：收集至少过去80个交易日（支持最长尺度）的每日数据，包括14个时序量价特征（如短期收益率、交易量、波动率、换手率等）。

**目标标签**：计算未来 T 日（例如 T=5 或 T=20）的股票收益率 R_{i,t+T} 作为模型训练的回归目标。

#### C. 特征工程与标准化

**跨截面标准化**：对所有个股的时序量价特征，在同一交易日进行 Z-score 或 Rank 标准化，以消除截面异质性对注意力机制的影响。

**时序处理**：将每个股票的14维特征序列处理成 (T_history,14) 的张量，其中 T_history ≥80。

## 阶段二：图结构构建 (Graph Construction)

PINN-MTICG模型依赖两种图结构来驱动GAT，这些图的邻接矩阵需要每日或周期性更新。

### 构建行业关联图（结构图）

**基础连接**：基于申万一级行业分类，将同一行业内的所有股票视为完全连接或通过行业节点连接。

**跨行业边**：识别和构建产业链上下游、或具有共同风险暴露的跨行业边。这可能通过计算跨行业股票的历史收益率相关性或共同主题标签来确定。

**邻接矩阵**：生成行业图的邻接矩阵 A_Industry。

## 阶段三：模型模块实现 (Module Implementation)

### 5. Multi-Transformer 时序编码器

**独立编码器**：实现三个独立的 Transformer 编码器 E_20, E_40, E_80。每个编码器由多层（例如2-4层）多头自注意力机制和前馈神经网络组成。

**输入处理**：将股票 i 过去 T_scale 日（20, 40, 80）的特征序列输入对应的编码器，得到高维特征向量 F_20, F_40, F_80。

**门控融合层**：实现一个小型MLP网络 G 和 Softmax 函数，对三个尺度的特征进行动态加权融合。

F_TS = w_20 F_20 + w_40 F_40 + w_80 F_80

F_TS 即为个股的时序特征表示。

### 6. indcap-GAT 截面关联编码器

**节点特征**：GAT的节点特征输入 X_node 必须是步骤5中得到的时序编码特征 F_TS。

**GAT层实现**：使用 PyG 库实现 GATConv 层，以处理动态图 A_Capital 和结构图 A_Industry。可以考虑并行使用两个GAT层分别处理两种图，并将输出特征拼接或加权融合。

**输出**：得到融合了截面关联信息的中观特征 F_CS。

### 7. PINN 宏观状态网络 (N_PINN)

**网络结构**：实现一个小型多层感知机（MLP）网络 N_PINN，用于拟合宏观状态的虚拟变量 Z_NN(t)。

**输入/输出**：输入可以是时间 t 或当前宏观变量的特征，输出是隐变量 Z_NN(t)。

**物理损失项**：定义宏观状态方程（ODE/PDE）的残差函数 R(⋅)。例如，假设宏观流动性 Z 的演化规律与利率 R 和融资需求 T 相关：

R(Z,R,T) ≡ ∂Z/∂t − f(Z,R,T) = 0

使用PyTorch的自动微分功能计算 ∂Z_NN/∂t，并定义物理损失 L_PINN = ||R(⋅)||^2。

## 阶段四：网络集成与训练 (Integration & Training)

### 8. 最终特征融合与解码

**融合层**：将时序特征 F_TS、截面特征 F_CS、以及宏观特征 F_Macro（即 Z_NN(t) 或从 N_PINN 提取的特征）进行拼接（Concat）。

**非线性映射**：使用2-3层MLP来学习这些多模态特征的非线性交互项，得到最终的组合特征 F_Combined。

**解码器**：使用一个线性层（全连接层）作为最终的解码器，将 F_Combined 映射到预测的因子得分 R̂_{i,t+T}。

### 9. 损失函数与优化

**总损失函数**：PINN-MTICG的训练目标是最小化总损失 L_Total。

L_Total = L_Prediction + λ_PINN L_PINN + λ_Reg L_Regularization

**预测损失 (L_Prediction)**：推荐从均方误差（MSE）开始，以确保训练稳定。在收敛后，可以切换或添加排名损失（Rank Loss），以直接优化因子信息系数（IC）。

**PINN损失 (L_PINN)**：采用步骤7中定义的物理损失项。

**权重平衡 (λ_PINN)**：λ_PINN 是关键的超参数。建议先将 λ_PINN 设为0，使模型仅关注 L_Prediction。在 L_Prediction 稳定收敛后，再逐步引入和增加 λ_PINN（例如从 10^{-4} 到 10^{-2}），以校准宏观约束。

**优化器**：推荐使用 Adam 或 AdamW 优化器。

## 阶段五：预测与评估 (Prediction & Evaluation)

### 10. 因子生成与预测

**因子得分**：使用训练好的PINN-MTICG模型，输入当前交易日 t 的所有个股数据和宏观数据，输出每只股票的预测因子得分 R̂_{i,t+T}。

**选股决策**：基于因子得分 R̂_{i,t+T} 对全市场股票进行排序。

**投资组合构建**：根据得分选择最高的一组股票（例如，排名前10%或前三组）构建多头组合。

### 11. 性能评估

将模型的预测结果与原报告的关键性能指标进行对标，以验证复现的有效性：

**核心因子指标**：计算因子月平均IC（目标：11.41%）。

**组合收益指标**：计算多头组合的年化收益率（目标：37.51%）和月平均单边换手率（目标：0.83X）。

**超额收益指标**：计算相对于基准指数（如沪深300）的指数增强超额收益（目标：13.22%）。