# æ¨¡å‹æ­£ç¡®ç‡åˆ¤æ–­æœºåˆ¶è¯´æ˜

## ğŸ“Š ä¸€ã€æ ‡ç­¾ç”Ÿæˆï¼ˆäº”åˆ†ä½æ•°åˆ†ç±»ï¼‰

### 1.1 æ ‡ç­¾ç”Ÿæˆæµç¨‹

åœ¨ `components/data_loader.py` çš„ `prepare_sequences()` æ–¹æ³•ä¸­ï¼Œæ ‡ç­¾æ˜¯é€šè¿‡ä»¥ä¸‹æ­¥éª¤ç”Ÿæˆçš„ï¼š

```python
# 1. è®¡ç®—æ‰€æœ‰æ ·æœ¬çš„æœªæ¥æ”¶ç›Šç‡
all_future_returns = []
for industry in industries:
    for i in range(len(data) - max_window - future_days + 1):
        start_price = current_prices[i+max_window-1]
        end_price = current_prices[i+max_window+future_days-1]
        future_return = (end_price - start_price) / start_price
        all_future_returns.append(future_return)

# 2. è®¡ç®—äº”åˆ†ä½æ•°é˜ˆå€¼
all_future_returns_array = np.array(all_future_returns)
quantiles = np.percentile(all_future_returns_array, [20, 40, 60, 80])
# quantiles = [q20, q40, q60, q80]
# ä¾‹å¦‚: [-0.05, -0.02, 0.01, 0.04]

# 3. æ ¹æ®æœªæ¥æ”¶ç›Šç‡åˆ†é…æ ‡ç­¾
if future_return <= quantiles[0]:      # <= 20%åˆ†ä½æ•°
    target = 0  # æœ€ä½20% (æœ€å·®æ”¶ç›Š)
elif future_return <= quantiles[1]:   # 20% < x <= 40%
    target = 1  # 20-40%
elif future_return <= quantiles[2]:   # 40% < x <= 60%
    target = 2  # 40-60% (ä¸­ç­‰)
elif future_return <= quantiles[3]:   # 60% < x <= 80%
    target = 3  # 60-80%
else:                                  # > 80%åˆ†ä½æ•°
    target = 4  # æœ€é«˜20% (æœ€å¥½æ”¶ç›Š)
```

### 1.2 æ ‡ç­¾å«ä¹‰

| æ ‡ç­¾ | å«ä¹‰ | æ”¶ç›Šç‡èŒƒå›´ | ç¤ºä¾‹ |
|------|------|-----------|------|
| 0 | æœ€ä½20% | â‰¤ 20%åˆ†ä½æ•° | â‰¤ -5% |
| 1 | 20-40% | (20%, 40%åˆ†ä½æ•°] | (-5%, -2%] |
| 2 | 40-60% | (40%, 60%åˆ†ä½æ•°] | (-2%, 1%] |
| 3 | 60-80% | (60%, 80%åˆ†ä½æ•°] | (1%, 4%] |
| 4 | æœ€é«˜20% | > 80%åˆ†ä½æ•° | > 4% |

**é‡è¦è¯´æ˜**ï¼š
- åˆ†ä½æ•°é˜ˆå€¼æ˜¯**åŠ¨æ€è®¡ç®—**çš„ï¼ŒåŸºäºå½“å‰æ•°æ®é›†çš„æ‰€æœ‰æ ·æœ¬
- æ¯ä¸ªæ ·æœ¬çš„æ ‡ç­¾è¡¨ç¤ºå…¶æœªæ¥æ”¶ç›Šç‡åœ¨**æ‰€æœ‰æ ·æœ¬ä¸­çš„ç›¸å¯¹æ’å**
- æ ‡ç­¾0-4æ˜¯**æœ‰åºçš„**ï¼š0æœ€å·®ï¼Œ4æœ€å¥½

## ğŸ¯ äºŒã€æ¨¡å‹é¢„æµ‹è¾“å‡º

### 2.1 æ¨¡å‹è¾“å‡ºæ ¼å¼

æ¨¡å‹è¾“å‡ºæ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º `[batch_size, 5]` çš„å¼ é‡ï¼Œè¡¨ç¤º5ä¸ªç±»åˆ«çš„**æœªå½’ä¸€åŒ–logits**ï¼š

```python
predictions = model(...)  # [batch_size, 5]
# ä¾‹å¦‚: [[2.1, 0.5, -1.2, 0.8, 1.5],  # æ ·æœ¬1çš„5ä¸ªç±»åˆ«logits
#        [0.3, 1.8, 0.2, -0.5, 2.1]]  # æ ·æœ¬2çš„5ä¸ªç±»åˆ«logits
```

### 2.2 é¢„æµ‹ç±»åˆ«è§£ç 

é€šè¿‡ `argmax` è·å–é¢„æµ‹ç±»åˆ«ï¼š

```python
pred_classes = predictions.argmax(dim=1)  # [batch_size]
# ä¾‹å¦‚: [0, 4]  # æ ·æœ¬1é¢„æµ‹ä¸ºç±»åˆ«0ï¼Œæ ·æœ¬2é¢„æµ‹ä¸ºç±»åˆ«4
```

**æ³¨æ„**ï¼š`argmax` è¿”å›çš„æ˜¯**æ¦‚ç‡æœ€å¤§çš„ç±»åˆ«ç´¢å¼•**ï¼Œå³é¢„æµ‹çš„äº”åˆ†ä½æ•°ç±»åˆ«ï¼ˆ0-4ï¼‰ã€‚

## âœ… ä¸‰ã€æ­£ç¡®ç‡åˆ¤æ–­æœºåˆ¶

### 3.1 å‡†ç¡®ç‡è®¡ç®—ï¼ˆä¸¥æ ¼åŒ¹é…ï¼‰

åœ¨ `components/trainer.py` çš„ `train_epoch()` å’Œ `validate()` æ–¹æ³•ä¸­ï¼Œå‡†ç¡®ç‡é€šè¿‡**ä¸¥æ ¼åŒ¹é…**è®¡ç®—ï¼š

```python
# è®­ç»ƒ/éªŒè¯æ—¶
pred_classes = predictions.argmax(dim=1)  # é¢„æµ‹ç±»åˆ« [batch_size]
targets = batch['target']                  # çœŸå®æ ‡ç­¾ [batch_size]

# ç»Ÿè®¡å®Œå…¨åŒ¹é…çš„æ•°é‡
correct = (pred_classes == targets).sum().item()
total = targets.size(0)
accuracy = 100 * correct / total
```

### 3.2 åˆ¤æ–­é€»è¾‘

**é¢„æµ‹æ­£ç¡®**çš„æ¡ä»¶ï¼š
- é¢„æµ‹ç±»åˆ« == çœŸå®æ ‡ç­¾ï¼ˆ**å®Œå…¨ç›¸ç­‰**ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# ç¤ºä¾‹1ï¼šæ­£ç¡®é¢„æµ‹
çœŸå®æ ‡ç­¾: 4 (æœ€é«˜20%)
é¢„æµ‹ç±»åˆ«: 4 (æœ€é«˜20%)
ç»“æœ: âœ… æ­£ç¡®

# ç¤ºä¾‹2ï¼šé”™è¯¯é¢„æµ‹
çœŸå®æ ‡ç­¾: 4 (æœ€é«˜20%)
é¢„æµ‹ç±»åˆ«: 3 (60-80%)
ç»“æœ: âŒ é”™è¯¯ï¼ˆå³ä½¿é¢„æµ‹çš„æ˜¯æ¬¡é«˜ç±»åˆ«ï¼‰

# ç¤ºä¾‹3ï¼šé”™è¯¯é¢„æµ‹
çœŸå®æ ‡ç­¾: 2 (40-60%)
é¢„æµ‹ç±»åˆ«: 1 (20-40%)
ç»“æœ: âŒ é”™è¯¯ï¼ˆå³ä½¿åªå·®ä¸€ä¸ªç­‰çº§ï¼‰
```

### 3.3 å‡†ç¡®ç‡å«ä¹‰

- **å‡†ç¡®ç‡ = é¢„æµ‹ç±»åˆ«å®Œå…¨åŒ¹é…çœŸå®æ ‡ç­¾çš„æ¯”ä¾‹**
- è¿™æ˜¯ä¸€ä¸ª**ä¸¥æ ¼çš„åˆ†ç±»å‡†ç¡®ç‡**ï¼Œä¸è€ƒè™‘"æ¥è¿‘æ­£ç¡®"çš„æƒ…å†µ
- ä¾‹å¦‚ï¼šå¦‚æœçœŸå®æ ‡ç­¾æ˜¯4ï¼Œé¢„æµ‹æ˜¯3ï¼Œå³ä½¿å¾ˆæ¥è¿‘ï¼Œä¹Ÿç®—é”™è¯¯

## ğŸ“ˆ å››ã€å…¶ä»–è¯„ä¼°æŒ‡æ ‡

é™¤äº†å‡†ç¡®ç‡ï¼Œé¡¹ç›®è¿˜ä½¿ç”¨ä»¥ä¸‹é‡‘èæŒ‡æ ‡è¯„ä¼°æ¨¡å‹ï¼š

### 4.1 IC (Information Coefficient)
- **å®šä¹‰**ï¼šé¢„æµ‹å€¼ä¸çœŸå®æ”¶ç›Šç‡çš„Pearsonç›¸å…³ç³»æ•°
- **è®¡ç®—**ï¼š`IC = corr(predictions, returns)`
- **èŒƒå›´**ï¼š[-1, 1]ï¼Œè¶Šæ¥è¿‘1è¶Šå¥½
- **å«ä¹‰**ï¼šè¡¡é‡é¢„æµ‹å€¼ä¸å®é™…æ”¶ç›Šç‡çš„çº¿æ€§ç›¸å…³æ€§

### 4.2 RankIC
- **å®šä¹‰**ï¼šé¢„æµ‹å€¼æ’åºä¸çœŸå®æ”¶ç›Šç‡æ’åºçš„Spearmanç§©ç›¸å…³ç³»æ•°
- **è®¡ç®—**ï¼š`RankIC = spearmanr(predictions, returns)`
- **èŒƒå›´**ï¼š[-1, 1]ï¼Œè¶Šæ¥è¿‘1è¶Šå¥½
- **å«ä¹‰**ï¼šè¡¡é‡é¢„æµ‹æ’åºä¸å®é™…æ”¶ç›Šæ’åºçš„ä¸€è‡´æ€§ï¼ˆæ›´ç¨³å¥ï¼‰

### 4.3 åˆ†ä½æ•°åˆ†æ (Quantile Analysis)
- **æ–¹æ³•**ï¼šå°†é¢„æµ‹å€¼åˆ†æˆ5ä¸ªåˆ†ä½æ•°ç»„ï¼Œè®¡ç®—æ¯ç»„çš„å¹³å‡æ”¶ç›Šç‡
- **æœŸæœ›**ï¼šé¢„æµ‹å€¼é«˜çš„åˆ†ä½æ•°ç»„åº”è¯¥æœ‰æ›´é«˜çš„å¹³å‡æ”¶ç›Šç‡
- **æŒ‡æ ‡**ï¼š`long_short_return` = æœ€é«˜åˆ†ä½æ•°å¹³å‡æ”¶ç›Š - æœ€ä½åˆ†ä½æ•°å¹³å‡æ”¶ç›Š

### 4.4 èƒœç‡ (Win Rate)
- **å®šä¹‰**ï¼šé¢„æµ‹æ–¹å‘ä¸å®é™…æ–¹å‘ä¸€è‡´çš„æ¯”ä¾‹
- **è®¡ç®—**ï¼š`win_rate = mean((pred > 0) == (return > 0))`
- **èŒƒå›´**ï¼š[0, 1]ï¼Œ>0.5è¡¨ç¤ºæœ‰é¢„æµ‹èƒ½åŠ›

## ğŸ” äº”ã€ä¸ºä»€ä¹ˆä½¿ç”¨ä¸¥æ ¼åŒ¹é…ï¼Ÿ

### 5.1 äº”åˆ†ä½æ•°åˆ†ç±»çš„ç‰¹ç‚¹

1. **ç›¸å¯¹æ’å**ï¼šæ ‡ç­¾è¡¨ç¤ºçš„æ˜¯ç›¸å¯¹æ’åï¼Œä¸æ˜¯ç»å¯¹æ”¶ç›Šç‡
2. **ç±»åˆ«å¹³è¡¡**ï¼šæ¯ä¸ªç±»åˆ«ç†è®ºä¸ŠåŒ…å«20%çš„æ ·æœ¬
3. **æœ‰åºæ€§**ï¼šç±»åˆ«0-4æ˜¯æœ‰åºçš„ï¼Œä½†å‡†ç¡®ç‡è®¡ç®—ä¸è€ƒè™‘é¡ºåº

### 5.2 ä¸¥æ ¼åŒ¹é…çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•ç›´è§‚ï¼šé¢„æµ‹ç±»åˆ« = çœŸå®ç±»åˆ«
- âœ… æ ‡å‡†åˆ†ç±»ä»»åŠ¡ï¼šç¬¦åˆå¤šåˆ†ç±»é—®é¢˜çš„æ ‡å‡†è¯„ä¼°æ–¹å¼
- âœ… æ˜“äºç†è§£ï¼šå‡†ç¡®ç‡ç›´æ¥åæ˜ "é¢„æµ‹æ­£ç¡®"çš„æ¯”ä¾‹

**ç¼ºç‚¹**ï¼š
- âŒ ä¸è€ƒè™‘"æ¥è¿‘æ­£ç¡®"ï¼šé¢„æµ‹ç±»åˆ«3ï¼ŒçœŸå®ç±»åˆ«4ï¼Œç®—é”™è¯¯
- âŒ ä¸åˆ©ç”¨ç±»åˆ«æœ‰åºæ€§ï¼šç±»åˆ«0å’Œ4çš„è·ç¦»ä¸ç±»åˆ«3å’Œ4çš„è·ç¦»ç›¸åŒ

### 5.3 å¯èƒ½çš„æ”¹è¿›æ–¹å‘

å¦‚æœéœ€è¦è€ƒè™‘"æ¥è¿‘æ­£ç¡®"ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

1. **Top-Kå‡†ç¡®ç‡**ï¼šé¢„æµ‹ç±»åˆ«åœ¨çœŸå®ç±»åˆ«çš„Top-KèŒƒå›´å†…ç®—æ­£ç¡®
2. **åŠ æƒå‡†ç¡®ç‡**ï¼šæ ¹æ®ç±»åˆ«è·ç¦»åŠ æƒï¼Œä¾‹å¦‚é¢„æµ‹3çœŸå®4çš„æƒé‡ > é¢„æµ‹0çœŸå®4çš„æƒé‡
3. **å›å½’æŒ‡æ ‡**ï¼šå°†ç±»åˆ«è½¬æ¢ä¸ºè¿ç»­å€¼ï¼ˆ-2, -1, 0, 1, 2ï¼‰ï¼Œä½¿ç”¨MAE/MSE

## ğŸ“ å…­ã€ä»£ç ä½ç½®æ€»ç»“

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | å…³é”®ä»£ç  |
|------|---------|---------|
| æ ‡ç­¾ç”Ÿæˆ | `components/data_loader.py` | `prepare_sequences()` ç¬¬418-451è¡Œ |
| å‡†ç¡®ç‡è®¡ç®— | `components/trainer.py` | `train_epoch()` ç¬¬220-221è¡Œ<br>`validate()` ç¬¬295-296è¡Œ |
| é‡‘èæŒ‡æ ‡ | `components/metrics.py` | `FinancialMetricsCalculator` ç±» |
| æ¨¡å‹é¢„æµ‹ | `components/trainer.py` | `predict()` ç¬¬421-465è¡Œ |

## ğŸ“ ä¸ƒã€æ€»ç»“

1. **æ ‡ç­¾ç”Ÿæˆ**ï¼šåŸºäºæœªæ¥æ”¶ç›Šç‡çš„äº”åˆ†ä½æ•°ï¼ŒåŠ¨æ€è®¡ç®—é˜ˆå€¼ï¼Œåˆ†é…0-4æ ‡ç­¾
2. **æ¨¡å‹è¾“å‡º**ï¼š5ä¸ªç±»åˆ«çš„logitsï¼Œé€šè¿‡argmaxå¾—åˆ°é¢„æµ‹ç±»åˆ«ï¼ˆ0-4ï¼‰
3. **å‡†ç¡®ç‡åˆ¤æ–­**ï¼š**ä¸¥æ ¼åŒ¹é…**ï¼Œé¢„æµ‹ç±»åˆ«å¿…é¡»å®Œå…¨ç­‰äºçœŸå®æ ‡ç­¾æ‰ç®—æ­£ç¡®
4. **å…¶ä»–æŒ‡æ ‡**ï¼šICã€RankICã€åˆ†ä½æ•°åˆ†æç­‰é‡‘èæŒ‡æ ‡æä¾›æ›´å…¨é¢çš„è¯„ä¼°

å½“å‰é¡¹ç›®çš„å‡†ç¡®ç‡æ˜¯**ä¸¥æ ¼çš„åˆ†ç±»å‡†ç¡®ç‡**ï¼Œä¸è€ƒè™‘"æ¥è¿‘æ­£ç¡®"çš„æƒ…å†µã€‚å¦‚æœéœ€è¦æ›´çµæ´»çš„è¯„ä¼°æ–¹å¼ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨Top-Kå‡†ç¡®ç‡æˆ–å›å½’æŒ‡æ ‡ã€‚

